<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Torneo Aristoi III</title>
    <!-- Librer√≠a Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1e293b; --secondary: #64748b; --accent: #10b981; --bg: #f1f5f9; --card-bg: #ffffff; --text: #0f172a; --border-radius: 12px; --success: #10b981; --bg: #f1f5f9; --text: #0f172a; --border-radius: 12px; 
            --primary: #1e293b;
            --secondary: #64748b;
            --accent: #10b981;
            --bg: #f1f5f9;
            --card-bg: #ffffff;
            --text: #0f172a;
            --border-radius: 12px;
            --success: #10b981;
        }
   * { box-sizing: border-box: border: 1px solid #e2e8f0; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            line-height: 1.5;
            /* Fix for black screen / sticky header overlap */
            position: relative; z-index: 1; 
        }

        header {
            background-color: var(--primary);
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); 
            position: sticky; 
            top: 0; 
            z-index: 100; /* Header above all */
        }

        h1 { margin: 0; font-size: 1.5rem; font-weight: 700; width: 100%; margin-bottom: 0.25rem; }
        h2, h3, h4 { color: var(--primary); margin-top: 0; font-weight: 600; }
        small { color: #94a3b8; fontsize: 0.85rem; }

        nav button {
            background: rgba(255,255,255,0.1); 
            border: 1px solid rgba(255,255,255,0.2); 
            color: white; 
            padding: 0.6rem 1.2rem; 
            cursor: pointer; 
            border-radius: 8px; 
            margin-left: 0.5rem; 
            transition: all 0.2s; 
            font-weight: 500; 
            font-size: 0.9rem;
        }
        nav button:hover, nav button.active { background: white; color: var(--primary); transform: translateY(-1px); }

        main { 
            padding: 2rem; 
            max-width: 1400px; 
            margin: 0 auto; 
            padding-bottom: 4rem;
            /* Ensure body is above header */
            position: relative; 
            z-index: 0; 
            margin-top: 0; 
            padding-top: 60px; /* Push body down */
        }

        section { display: none; animation: slideUp 0.4s ease-out; }
        section.active { display: block; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .card { 
            background: var(--card-bg); 
            padding: 2rem; 
            border-radius: var(--border-radius); 
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1); 
            margin-bottom: 2rem; 
            border: 1px solid #e2e8f0;
        }

        /* Inputs & Forms */
        input[type="text"], input[type="number"], select, textarea { 
            width: 100%; 
            padding: 0.75rem 1rem; 
            border: 1px solid #cbd5e1; 
            border-radius: 8px; 
            font-size: 0.95rem; 
            font-family: inherit; 
            transition: border-color: 0.2s ease; 
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent); ring: 2px solid rgba(16, 185, 129, 0.2); }
        
        .form-group { margin-bottom: 1rem; }
        label { display: block; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--secondary); }

        /* Buttons */
        .btn { 
            background-color: var(--primary); 
            color: white; 
            border: none; 
            padding: 0.75rem 1.5rem; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 0.9rem; 
            font-weight: 600; 
            margin-right: 0.5rem; 
            transition: all 0.2s; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center;
        }
        .btn:hover { background-color: #334155; transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .btn-success { background-color: var(--accent); }
        .btn-success:hover { background-color: #059669; }
        .btn-danger { background-color: #ef4444; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: #f8fafc; color: var(--primary); }
        .btn-remove { background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 6px; cursor: pointer; font-size: 0.75rem; margin-left: 8px; }
        
        /* Tables */
        .table-container { overflow-x: auto; border-radius: 8px; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background-color: #f8fafcf8fafc; font-weight: 600; color: var(--secondary); text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; }
        tr:hover td { background-color: #f8fafc; }
        
        /* Rubric Styles */
        .rubric-container { display: grid; grid-template-columns: 1fr 1fr; gap: 2.5rem; background: #fff; padding: 1rem; border: 1px solid #e2e8f0; border-radius: var(--border-radius); }
        .team-column { border: 1px solid #e2e8f0; border-radius: 10px; padding: 1.5rem; background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .team-column.team-a { border-top: 5px solid #10b981; }
        .team-column.team-b { border-top: 5px solid #ef4444; }
        .rubric-section { margin-bottom: 1.5rem; border-bottom: 1px dashed #e2e8f0; padding-bottom: 1rem; }
        .rubric-section:last-child { border-bottom: none; }
        .rubric-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .rubric-label { font-size: 0.85rem; color: #475569; flex: 1; padding-right: 10px; }
        .rubric-input-wrapper { display: flex; align-items: center; gap: 5px; }
        .rubric-input-wrapper input { width: 60px; text-align: center; padding: 4px 8px; }
        .rubric-max { font-size: 0.75rem; color: #94a3b8; width: 25px; text-align: right; }
        .subtotal-row { background: #f1f5f9; padding: 0.5rem 0.75rem; border-radius: 6px; font-weight: 600; display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.9rem; color: var(--primary); }
        .grand-total { font-size: 1.75rem; font-weight: 700; text-align: right; margin-top: 1.5rem; color: var(--primary); padding: 1rem; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; }
        
        /* Nominations */
        .nom-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr); gap: 1rem; margin-top: 1rem; }
        .nom-select { font-size: 0.9rem; }
        
        .hidden { display: none !important; }
        .badge { display: inline-block; padding: 0.25rem 0.6rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600; }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-neutral { background: #f1f5f9; color: #475569; }
        
        #judge-finished-msg { text-align: center; padding: 4rem 2rem; color: var(--secondary); }
        #judge-finished-msg svg { width: 64px; height: 64px; color: var(--success); margin-bottom: 1rem; }
        .io-box { border: 1px dashed #cbd5e1; padding: 1rem; border-radius: 8px; background: #fff; margin-bottom: 1rem; }
        @media (max-width: 900px) { .rubric-container { grid-template-columns: 1fr; 1fr; gap: 2.5rem; } }
    </style>
</head>
<body>

<header>
    <div>
        <h1>Torneo Debate Aristoi III</h1>
        <small>Gesti√≥n Oficial v13</small>
    </div>
    <nav>
        <button onclick="showSection('admin-panel')" id="nav-admin" class="active">Organizaci√≥n</button>
        <button onclick="showSection('judge-view')" id="nav-judge">Vista Juez</button>
    </nav>
</header>

<main>
    <!-- ================= ADMIN PANEL ================= -->
    <section id="admin-panel" class="active">
        
        <!-- Excel Import/Export -->
        <div class="io-box">
            <div style="display:flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                <div>
                    <strong>üíæ Copia de Seguridad / Excel</strong>
                    <div style="font-size:0.85rem; color: #64748b; margin-bottom: 0.5rem;">
                        Exporta a Excel para guardar. Importar un Excel para cargar resultados.
                    </div>
                </div>
                <div style="display:flex; gap:0.5rem;">
                    <button class="btn btn-success" onclick="exportToExcel()">üì§ Exportar a Excel</button>
                    <label class="btn btn-outline" style="cursor: pointer;">
                        üì• Importar Excel <input type="file" id="excel-input" accept=".xlsx, .xls" style="display: none;" onchange="importFromExcel(this)">
                        </label>
                    </div>
                </div>
            </div>

        <div style="margin-bottom: 2rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <button class="btn btn-outline" onclick="toggleSetup('teams')">Gestionar Equipos</button>
            <button class="btn btn-outline" onclick="toggleSetup('judges')">Gestionar Jueces</button>
            <button class="btn btn-outline" onclick="toggleSetup('pairings')">Generar Rondas</button>
            <button class="btn btn-outline" onclick="toggleSetup('awards')">Clasificaciones</button>
        </div>

        <!-- 1. Teams -->
        <div id="setup-teams" class="card">
            <h2>Gesti√≥n de Equipos</h2>
            <div class="form-group"><label>Nombre</label><input type="text" id="new-team-name"><input type="hidden" id="edit-team-id"></div>
            <div class="form-group">
                <label>Miembros</label>
                <div id="members-container"></div>
                <button class="btn btn-outline" onclick="addMemberInput()">+ Miembro</button>
            </div>
            <div style="margin-top: 1rem;">
                <button class="btn" onclick="saveTeam()">Guardar</button>
                <button class="btn btn-danger hidden" id="cancel-edit-btn" onclick="resetTeamForm()">Cancelar</button>
            </div>
            <hr style="border: 0; border-top: 1px solid #e2e8f0; margin: 2rem 0;">
            <div class="table-container"><table id="teams-table"><thead><tr><th>Equipo</th><th>Miembros</th><th>Acciones</th></tr></thead><tbody></tbody></tbody></table></div>
        </div>

        <!-- 2. Judges -->
        <div id="setup-judges" class="card hidden">
            <h2>Gesti√≥n de Jueces</h2>
            <div class="form-group">
                <input type="hidden" id="edit-judge-id">
                <label>Nombre</label><input type="text" id="new-judge-name">
                <label style="font-weight: normal;">Incompatible con:</label>
                <select id="new-judge-conflicts" multiple style="height: 100px;"></select>
            </div>
            <div style="margin-top: 1rem;">
                <button class="btn" onclick="saveJudge()">Guardar Juez</button>
                <button class="btn btn-danger hidden" id="cancel-judge-edit-btn" onclick="resetJudgeForm()">Cancelar</button>
            </div>
            <div class="table-container"><table id="judges-table"><thead><tr><th>Juez</th><th>Incompatibilidades</th><th>Acciones</th></tr></thead><tbody></tbody></table></div>
        </div>

        <!-- 3. Pairings -->
        <div id="setup-pairings" class="card hidden">
            <h2>Emparejamientos</h2>
            <p id="pairing-mode-text" style="color: var(--secondary);"></p>
            <div style="margin: 1.5rem 0;">
                <button class="btn" onclick="generatePairings()">Generar Ronda</button>
                <span id="current-round-display" style="font-weight: 700; margin-left: 1rem; font-size: 1.1rem;">Ronda: 0</span>
            </div>
            <div class="table-container"><table id="pairings-table"><thead><tr><th>Mesa</th><th>Enfrentamiento</th><th>Jueces</th><th>Estado</th></tr></thead><tbody></tbody></table></div>
        </div>

        <!-- 4. Rankings -->
        <div id="setup-awards" class="card hidden">
            <h2 style="margin-bottom: 1.5rem;">Clasificaci√≥n General</h2>
            <h3 style="font-size: 1.1rem; color: var(--secondary); border-bottom: 1px solid #e2e8f0; padding-bottom: 0.5rem;">Ranking de Equipos</h3>
            <div class="table-container" style="margin-bottom: 2rem;"><table id="standings-table-final"><thead><tr><th>Pos</th><th>Equipo</th><th>Victorias</th><th>Puntos</th></tr></thead><tbody></tbody></tbody></table></div>
            <h3 style="font-size: 1.1rem; color: var(--secondary); border-bottom: 1px solid #e2e8f0; padding-bottom: 0.5rem;">Premios Individuales</h3>
            <div class="table-container"><table id="awards-table-final"><thead><tr><th>Categor√≠a</th><th>Ganador</th><th>Nominaciones</th></tr></thead><tbody></tbody></table></div>
        </div>
    </section>

    <!-- ================= JUDGE VIEW ================= -->
    <section id="judge-view">
        <div class="card" style="max-width: 1200px; margin: 0 auto;">
            <h2>Panel de Juez</h2>
            
            <div id="judge-login">
                <div class="form-group" style="max-width: 400px; margin: 0 auto;">
                    <label>Identif√≠quese:</label>
                    <select id="judge-selector" onchange="loadJudgeMatchups()"></select>
                </div>
            </div>

            <div id="judge-finished-msg" class="hidden">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0 9 9 0z"></path></svg>
                <h3>Finalizado</h3>
                <button class="btn" onclick="exportJudgeResults()">üì• Descargar Mis Resultados (Excel)</button>
                <button class="btn btn-outline" onclick="initJudgeView()">Reiniciar</button>
            </div>

            <div id="judge-scoring" class="hidden">
                <button class="btn btn-outline hidden" id="exit-judge-btn" onclick="initJudgeView()">‚Üê Salir</button>
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 1.5rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 1rem;">
                    <button class="btn" id="prev-match-btn" onclick="navigateMatch(-1)">‚Üê Anterior</button>
                    <div style="text-align:center;">
                        <h3 id="scoring-title" style="font-size: 1.25rem;">Hoja de Puntuaci√≥n</h3>
                        <span id="match-counter" class="badge badge-neutral"></span>
                    </div>
                    <button class="btn" id="next-match-btn" onclick="navigateMatch(1)">Siguiente ‚Üí</button>
                </div>
                
                <p style="color: var(--secondary); font-size: 0.9rem; text-align:center; margin-bottom: 2rem; max-width: 600px; margin-left: auto; margin-right: auto;">
                    Complete los campos. El sistema calcular√° los totales autom√°ticamente. 
                    <br><strong>Nota:</strong> Una vez pulsado "Guardar", no podr√° modificar.
                </p>

                <form id="rubric-form" onsubmit="submitScores(event)">
                    <div class="rubric-container">
                        <!-- EQUIPO A -->
                        <div class="team-column team-a">
                            <h4 style="color: #047857; margin-bottom: 1rem;">EQUIPO A FAVOR</h4>
                            <input type="hidden" id="score-team-id-a">
                            
                            <!-- GENERAL -->
                            <div class="rubric-section">
                                <div style="display:flex; justify-content:space-between; font-weight:700; font-size:0.8rem; color:#64748b; margin-bottom:0.5rem;"><span>GENERAL (25)</span></div>
                                <div class="rubric-row"><span class="rubric-label">Calidad/L√≠nea</span><div class="rubric-input-wrapper"><input type="number" min="0" max="10" class="score-input" data-team="A" data-sec="gen"> <span class="rubric-max">10</span></div></div>
                                <div class="rubric-row"><span class="rubric-label">Exordio</span><div class="rubric-input-wrapper"><input type="number" min="0" max="5" class="score-input" data-team="A" data-sec="gen"> <span class="rubric-max">5</span></div></div>
                                <div class="rubric-row"><span class="rubric-label">Victoria Arg.</span><div class="rubric-input-wrapper"><input type="number" min="0" max="10" class="input" data-team="A" data-sec="gen"> <span class="rubric-max">10</span></div></div>
                                <div class="subtotal-row"><span>Subtotal:</span> <span id="sub-A-gen">0</span></div>
                            </div>
                            <div class="rubric-section">
                                <div style="display:flex; justify-content:space-between; font-weight:700; font-size:0.8rem; color:#64748b; margin-bottom:0.5rem;"><span>INTRO (25)</span></div>
                                <div class="rubric-row"><span class="rubric-label">Arg.</span><div class="rubric-input-wrapper"><input type="number" min="0" max="5" class="score-input" data-team="A" data-sec="intro"> <span class="rubric-max">5</span></div></div>
                                <div class="rubric-row"><span class="rubric-label">Estilo</span><div class="rubric-input-wrapper"><input type="number" min="0" max="10" class="score-input" data-team="A" data-sec="intro"> <span class="rubric-max">10</span></div></div>
                                <div class="rubric-row"><span class="rubric-label">POIs</span><div class="rubric-input-wrapper"><input type="number" min="0" max="10" class="score-input" data-team="A" data-sec="intro"> <span class="ruby-max">10</span></div></div>
                                <div class="subtotal-row"><span>Subtotal:</span> <span id="sub-A-intro">0</span></div>
                            </div>
                            <div class="rubric-section">
                                <div style="display:flex; justify-content:space-between; font-weight:700; font-size:0.8rem; color:#64748b; margin-bottom:0.5rem;"><span>REFUT 1 (25)</span></div>
                                <div class="rubric-row"><span class="rubric-label">Arg. (ARE)</span><div class="rubric-input-wrapper"><input type="number" min="0" max="15" class="score-input" data-team="A" data-sec="r1"> <span class="ruby-max">15</span></div></div>
                                <div class="rubric-row"><span class="rubric-label">Refut.</span><div class="rubric-input-wrapper"><input type="number" min="0" max="5" class="score-input" data-team="A" data-sec="r1"> <span class="rubric-max">5</span></div></div>
                                <div class="rubric-row"><span class="rubric-label">Estilo</span><div class="rubric-input-wrapper"><input type="number" min="0" max="5" class="score-input" data-team="A" data-sec="r1"> <span class="rubric-max">5</span></div></div>
                                <div class="subtotal-row"><span>Subtotal:</span> <span id="sub-A-r2">0</span></div>
                            </div>
                            <div class="rubric-section">
                                <div style="display:flex; justify-content:space-between; font-weight:700; font-size:0.8rem; color:#64748b; margin-bottom:0.5rem;"><span>REFUT 2 (25)</span></div>
                                <div class="rubric-row"><span class="rubric-label">Refut.</span><div class="rubric-input-wrapper"><input type="number" min="0" max="15" class="score-input" data-team="A" data-sec="r2"> <span class="rubric-max">15</span></div></div>
                                <div class="rubric-row"><span class="rubric-label">Arg.</span><div class="rubric-input-wrapper"><input type="number" min="0" max="5" class="score-input" data-team="B" data-sec="r2"> <span class="rubric-max">5</span></div></div>
                                <div class="rubric-row"><span class="rubric-label">Estilo</span><div class="rubric-input-wrapper"><input type="number" min="0" max="5" class="input" data-team="B" data-sec="r2"> <span class="rubric-max">5</span></div></div>
                                <div class="rubric-row"><span class="rubric-label">Arg.</span><div class="rubric-input-wrapper"><input type="number" min="0" max="5" class="input" data-team="B" data-sec="r2"> <span class="rubric-max">5</span></div></div>
                                <div class="subtotal-row"><span>Subtotal:</span> <span id="sub-B-r2">0</span></div>
                            </div>
                            <div class="rubric-section">
                                <div style="display:flex; justify-content:space-between; font-weight:700; font-size:0.8rem; color:#64748b; margin-bottom:0.5rem;"><span>CONCLU (25)</span></div>
                                <div class="rubric-row"><span class="rubric-label">Estilo</span><div class="rubric-input-wrapper"><input type="number" min="0" max="15" class="score-input" data-team="B" data-sec="conclu"> <span class="rubric-max">15</span></div></div>
                                <div class="rubric-row"><span class="rubric-label">S√≠ntesis</span><div class="rubric-input-wrapper"><input type="number" min="0" max="10" class="score-input" data-team="B" data-sec="conclu"> <span class="rubric-max">10</span></div></div>
                                <div class="subtotal-row"><span>Subtotal:</span> <span id="sub-B-conclu">0</span></div>
                            </div>
                            <div class="grand-total">Total B: <span id="total-b">0</span></div>
                        </div>
                    </div>

                    <!-- Nominaciones -->
                    <div style="background: #f8fafc; padding: 2rem; margin-top: 2rem; border-radius: var(--border-radius); border: 1px solid #d6eaf8; border-radius: 8px; margin-top: 2rem;">
                        <h4 style="margin-top:0; color: var(--primary); margin-bottom: 1rem;">Nominaciones Individuales</h4>
                        <div class="nom-grid">
                            <div><label>üèÜ MEJOR ORADOR (MVP)</label><select id="nom-mvp" class="nom-select" required><option value="">-- Seleccionar --</option></select></div>
                            <div><label>üé§ Mejor Introducci√≥n</label><select id="nom-intro" class="nom-select" required><option value="">-- Seleccionar --</option></select></div>
                            <div><label>‚öîÔ∏è Mejor Refutaci√≥n 1</label><select id="nom-r1" class="nom-select" required><option value="">-- Seleccionar --</option></select></div>
                            <div><label>üõ°Ô∏è Mejor Refutaci√≥n 2</label><select id="nom-r2" class="nom-select" required><option value="">-- Seleccionar --</option></select></div>
            </div>
            <div style="text-align: center; margin-top: 2rem;">
                <button type="submit" class="btn" style="padding: 1rem 2.5rem; font-size: 1rem;">GUARDAR PUNTUACI√ìN</button>
            </div>
        </div>
    </section>
</main>
<script>
    const state = { teams: [], judges: [], rounds: [], currentRound: 0 };
    let isRestrictedMode = false;
    let myAssignedMatches = [], myCurrentMatchIndex = 0;

    function loadExampleData() {
        const t1 = { id: 't1', name: 'Escuela Atenea', members: [{id:'m1', name:'S√≥crates'}, {id:'m2', name:'Plat√≥n'}, {id:'m3', name:'Marco Aurelio'}, {id:'m4', name:'Epicteto'}, {id:'m5', name:'Alejandro'}], wins:0, points:0, speakerPoints:0, opponents:[] };
        const t2 = { id: 't2', name: 'Academia SPQR', members: [{id:'m3', name:'Cicer√≥n'}, {id:'m4', name:'S√©neca'}], wins:0, points:0, speakerPoints:0, opponents:[] };
        const j1 = { id: 'j1', name: 'Juez Pericles', conflicts: [] };
        const j2 = { id: 'j2', name: 'Juez Aspasia', conflicts: [] };
        state.teams = [t1, t2, t3, t4];
        state.judges = [j1, j2];
        state.rounds = [];
        saveState();
    }

    function loadState() {
        const saved = localStorage.getItem('aristoi_tournament_v13');
        if (saved) {
            const parsed = JSON.parse(saved);
            state.teams = parsed.teams || [];
            state.judges = parsed.judges || [];
            state.rounds = parsed.rounds || [];
            state.currentRound = parsed.currentRound || 0;
        } else {
            loadExampleData();
        }
        renderAll();
    }

    function saveState() {
        localStorage.setItem('aristoi_tournament_v13', JSON.stringify(state));
        renderAll();
    }

    function renderAll() {
        renderTeamsTable(); renderJudgesTable(); renderConflictOptions(); renderPairingsTable(); renderStandingsAndAwards(); renderAll();
        document.getElementById('current-round-display').innerText = `Ronda Actual: ${state.currentRound}`;
        document.getElementById('pairing-mode-text').innerText = state.currentRound === 0 ? "MODO: SORTEO ALEATORIO" : "MODO: SISTEMA SUIZO";
    }

    // ================= NAVIGATION =================
    function showSection(id) {
        if (isRestrictedMode && id !== 'judge-view') return;
        document.querySelectorAll('main > section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'admin-panel') document.getElementById('nav-admin').classList.add('active');
        if(id === 'judge-view') {
            document.getElementById('nav-judge').classList.add('active');
            initJudgeView();
        }
    }

    function toggleSetup(type) {
        ['setup-teams', 'setup-judges', 'setup-pairings', 'setup-awards'].forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById('setup-' + type).classList.remove('hidden');
    }

    // ================= TEAMS CRUD =================
    function addMemberInput(name = '') {
        const container = document.getElementById('members-container');
        const div = document.createElement('div');
        div.className = 'form-group';
        div.style.marginBottom = '0.5rem';
        div.innerHTML = `<input type="text" class="member-input" placeholder="Nombre" value="${name}"> <button type="button" class="btn-remove" onclick="this.parentElement.remove()">X</button>`;
        container.appendChild(div);
    }
    function resetTeamForm() {
        document.getElementById('edit-team-id').value = '';
        document.getElementById('new-team-name').value = '';
        document.getElementById('members-container').innerHTML = '';
        addMemberInput(); addMemberInput();
        document.querySelector('#setup-teams .btn').innerText = 'Guardar Equipo';
        document.getElementById('cancel-edit-btn').classList.add('hidden');
    }
    function editTeam(id) {
        const t = state.teams.find(x => x.id === id);
        if(!t) return;
        document.getElementById('edit-team-id').value = t.id;
        document.getElementById('new-team-name').value = t.name;
        document.getElementById('members-container').innerHTML = '';
        t.members.forEach(m => addMemberInput(m.name));
        document.querySelector('#setup-teams .btn').innerText = 'Actualizar Equipo';
        document.getElementById('cancel-edit-btn').classList.remove('hidden');
        toggleSetup('teams'); window.scrollTo(0,0);
    }
    function saveTeam() {
        const idInput = document.getElementById('edit-team-id').value;
        const name = document.getElementById('new-team-name').value.trim();
        if(!name) return alert("Nombre requerido");
        const memberInputs = document.querySelectorAll('.member-input');
        const members = [];
        memberInputs.forEach((inp, idx) => {
            if(inp.value.trim()) members.push({ id: (idInput ? idInput : Date.now()) + '_' + idx, name: inp.value.trim() }));
        });
        if(members.length === 0) return alert("A√±ade al menos 1 miembro");
        if(idInput) { const t = state.teams.find(x => x.id === idInput); t.name = name; t.members = members; }
        else { state.teams.push({ id: Date.now().toString(), name: name, members: members, wins: 0, points: 0, speakerPoints: 0, opponents: [] }); }
        resetTeamForm(); saveState();
    }
    function deleteTeam(id) { if(confirm("¬øBorrar?")) { state.teams = state.teams.filter(t => t.id !== id); saveState(); } }

    function renderTeamsTable() {
        const tbody = document.getElementById('teams-table').querySelector('tbody');
        tbody.innerHTML = '';
        state.teams.forEach(t => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${t.name}</td><td><small>${t.members.map(m=>m.name).join(', ')}</small></td><td><button class="btn btn-outline" style="font-size:0.8rem;" onclick="editTeam('${t.id}')">Editar</button> <button class="btn btn-remove" onclick="deleteTeam('${t.id}')">Borrar</button></td>`;
            tbody.appendChild(tr);
        });
    }

    // ================= JUDGES CRUD =================
    function resetJudgeForm() {
        document.getElementById('edit-judge-id').value = '';
        document.getElementById('new-judge-name').value = '';
        document.getElementById('new-judge-conflicts').selectedIndex = -1;
        document.querySelector('#setup-judges .btn').innerText = 'Guardar Juez';
        document.getElementById('cancel-judge-edit-btn').classList.add('hidden');
    }
    function editJudge(id) {
        const j = state.judges.find(x => x.id === id);
        if(!j) return;
        document.getElementById('edit-judge-id').value = j.id;
        document.getElementById('new-judge-name').value = j.name;
        const sel = document.getElementById('new-judge-conflicts');
        Array.from(sel.options).forEach(opt => { opt.selected = j.conflicts.includes(opt.value); }); });
        document.querySelector('#setup-judges .btn').innerText = 'Actualizar Juez';
        document.getElementById('cancel-judge-edit-btn').classList.remove('hidden');
        toggleSetup('judges'); window.scrollTo(0,0);
    }
    function saveJudge() {
        const idInput = document.getElementById('edit-judge-id').value;
        const name = document.getElementById('new-judge-name').value.trim();
        const conflicts = Array.from(document.getElementById('new-judge-conflicts').selectedOptions).map(o => o.value);

        if(!name) return alert("Nombre requerido");
        if(idInput) { const j = state.judges.find(x => x.id === idInput); j.name = name; j.conflicts = conflicts; }
        else { state.judges.push({ id: Date.now().toString(), name: name, conflicts: conflicts }); }
        resetJudgeForm(); saveState();
    }
    function deleteJudge(id) { if(confirm¬øBorrar?")) { state.judges = state.judges.filter(j => j.id !== id); saveState(); } }
    function renderJudgesTable() {
        const tbody = document.getElementById('judges-table').querySelector('tbody');
        tbody.innerHTML = '';("
        state.judges.forEach(j => {
            const cNames = j.conflicts.map(cid => state.teams.find(t=>t.id===cid)?.name).filter(Boolean).join(', ');
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${j.name}</td><td><small>${cNames||'Ninguna'}</small></td><td><button class="btn btn-outline" style="font-size:0.8rem;" onclick="editJudge('${j.id}')">Editar</button> <button class="btn btn-remove" onclick="deleteJudge('${j.id}')">Borrar</button></td>`;
            tbody.appendChild(tr);
        });
    }
    function renderConflictOptions() {
        const sel = document.getElementById('new-judge-conflicts');
        sel.innerHTML = '';
        state.teams.forEach(t => { const opt = document.createElement('option'); opt.value = t.id; opt.innerText = t.name; sel.appendChild(opt); });
    }

    // ================= PAIRING LOGIC =================
    function shuffle(array) { return array.sort(() => Math.random() - 0.5); }
    function generatePairings() {
        if (state.teams.length < 2) return alert("M√≠nimo 2 equipos.");
        if (state.teams.length % 2 !== 0) return alert("N√∫mero par de equipos.");
        if (state.rounds[state.currentRound] && state.rounds[state.currentRound].length > 0) {
            if(!confirm("¬øSeguro de regenerar ronda?")) return;
        }
        const roomsNeeded = state.teams.length / 2;
        let matchups = [];
        let teamPairs = [];
        if (state.currentRound === 0) {
            const shuffled = shuffle([...state.teams]);
            for(let i=0; i<shuffled.length; i+=2) teamPairs.push([shuffled[i], shuffled[i+1]]);
        } else {
            const sorted = [...state.teams].sort((a,b) => (b.wins - a.wins) || (b.points - a.points));
            const paired = new Set();
            for(let tA of sorted) {
                if(paired.has(tA.id)) continue;
                for(let tB of sorted) {
                    if(tA.id===tB.id || paired.has(tB.id)) continue;
                    if(tA.opponents.includes(tB.id)) continue;
                    teamPairs.push([tA, tB]);
                    paired.add(tA.id); paired.add(tB.id); break;
                }
            }
        }
        if(teamPairs.length < roomsNeeded) return alert("Error restricciones.");
        
        let assignedJudges = new Set();
        let availableJudges = shuffle([...state.judges]);
        const findCompatible = (pair, judgeList) => {
            return judgeList.find(j => !assignedJudges.has(j.id) && !j.conflicts.includes(pair[0].id) && !j.conflicts.includes(pair[1].id));
        };

        for(let pair of teamPairs) {const judge = findCompatible(pair, availableJudges);
            if(!judge) return alert(`No hay jueces para ${pair[0].name} vs ${pair
